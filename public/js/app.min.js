(function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P,Q,R,S,T,U,V,W,X,Y,Z,ab,bb,cb,db,eb,fb,gb,hb,ib,jb,kb,lb,mb,nb={}.hasOwnProperty,ob=function(a,b){function c(){this.constructor=a}for(var d in b)nb.call(b,d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a};j=window.Cruddy||{},a="/backend/api/v1",D="transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd",moment.lang(null!=(I=j.locale)?I:"en"),Backbone.emulateHTTP=!0,Backbone.emulateJSON=!0,$(document).ajaxError(function(a,b){return 403===b.status?location.href="/login":void 0}),$.extend($.fancybox.defaults,{openEffect:"elastic"}),H=function(a){return a.replace(/_-/," ")},G=function(a,b){var c;return c=j.root+"/"+j.uri+"/api/v1/entity/"+a,b&&(c+="/"+b),c},c=function(a){function b(){return J=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="span",b.prototype.className="alert",b.prototype.initialize=function(a){var b,c=this;return this.$el.addClass(null!=(b=this.className+"-"+a.type)?b:"info"),this.$el.text(a.message),null!=a.timeout&&setTimeout(function(){return c.remove()},a.timeout),this},b}(Backbone.View),b=function(){function a(a){this.original=new FormData,null!=a&&this.append(a)}return a.prototype.append=function(a,b){var c,d,e,f;if(void 0===b&&(b=a,a=null),b instanceof File||b instanceof Blob)return this.original.append(a,b);if(_.isArray(b)){if(_.isEmpty(b))return this.append(a,"");for(c=d=0,e=b.length;e>d;c=++d)f=b[c],this.append(this.key(a,c),f)}else{if(!_.isObject(b))return this.original.append(a,this.process(b));for(c in b)f=b[c],this.append(this.key(a,c),f)}},a.prototype.process=function(a){return null===a?"":a===!0?1:a===!1?0:a},a.prototype.key=function(a,b){return a?""+a+"["+b+"]":b},a}(),s=function(){function a(){}return a.prototype.create=function(a,b){var c;return c=this[a],null!=c?new c(b):(console.error("Failed to resolve "+a+"."),null)},a}(),e=function(a){function b(){return U=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b}(Backbone.Model),l=function(a){function b(){return fb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.defaults={data:[],search:""},b.prototype.initialize=function(a,b){var c=this;return this.entity=b.entity,null!=b.columns&&(this.columns=b.columns),null!=b.filter&&(this.filter=b.filter),null!=this.filter&&this.listenTo(this.filter,"change",this.fetch),this.on("change",function(){return c._hold?void 0:c.fetch()}),this.on("change:search",function(){return c.set({current_page:1,silent:!0})})},b.prototype.hasData=function(){return!_.isEmpty(this.get("data"))},b.prototype.isFull=function(){return this.get("current_page")===this.get("last_page")},b.prototype.fetch=function(){var a=this;return null!=this.request&&this.request.abort(),this.request=$.getJSON(this.entity.url(),this.data(),function(b){return a._hold=!0,a.set(b.data),a._hold=!1,a.trigger("data",a,b.data.data)}),this.request.fail(function(b){return a.trigger("error",a,b)}),this.request.always(function(){return a.request=null}),this.trigger("request",this,this.request),this.request},b.prototype.data=function(){var a,b;return a={order_by:this.get("order_by"),order_dir:this.get("order_dir"),page:this.get("current_page"),per_page:this.get("per_page"),q:this.get("search")},b=this.filterData(),_.isEmpty(b)||(a.filters=b),null!=this.columns&&(a.columns=this.columns.join(",")),a},b.prototype.filterData=function(){var a,b,c,d;if(null==this.filter)return null;a={},d=this.filter.attributes;for(b in d)c=d[b],null!==c&&""!==c&&(a[b]=c);return a},b}(Backbone.Model),z=function(a){function b(){return hb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="ul",b.prototype.className="pager",b.prototype.events={"click a":"navigate"},b.prototype.initialize=function(){return this.listenTo(this.model,"change:last_page change:current_page",this.render),$(document).on("keydown.pagination",$.proxy(this,"hotkeys")),this},b.prototype.hotkeys=function(a){return a.ctrlKey&&37===a.keyCode?(this.previous(),!1):a.ctrlKey&&39===a.keyCode?(this.next(),!1):this},b.prototype.page=function(a){return a>0&&a<=this.model.get("last_page")&&this.model.set("current_page",a),this},b.prototype.previous=function(){return this.page(this.model.get("current_page")-1)},b.prototype.next=function(){return this.page(this.model.get("current_page")+1)},b.prototype.navigate=function(a){return a.preventDefault(),this.page($(a.target).data("page"))},b.prototype.render=function(){return this.$el.html(this.template(this.model.get("current_page"),this.model.get("last_page"))),this},b.prototype.template=function(a,b){var c;return c="",a>1&&(c+=this.link(a-1,"&larr; Назад","previous")),b>a&&(c+=this.link(a+1,"Вперед &rarr;","next")),c},b.prototype.link=function(a,b,c){return null==c&&(c=""),'<li class="'+c+'"><a href="#" data-page="'+a+'">'+b+"</a></li>"},b}(Backbone.View),k=function(a){function b(a){this.className+=" data-grid-"+a.model.entity.id,b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="table",b.prototype.className="table table-hover table-condensed data-grid",b.prototype.events={"click .sortable":"setOrder","click .item":"navigate"},b.prototype.initialize=function(){return this.entity=this.model.entity,this.columns=this.entity.columns.models.filter(function(a){return a.get("visible")}),this.listenTo(this.model,"change:data",this.updateData),this.listenTo(this.model,"change:order_by change:order_dir",this.onOrderChange),this.listenTo(this.entity,"change:instance",this.onInstanceChange)},b.prototype.onOrderChange=function(){var a,b;return a=this.model.get("order_by"),b=this.model.get("order_dir"),null!=this.orderBy&&a!==this.orderBy&&this.$("#col-"+this.orderBy+" .sortable").removeClass("asc desc"),this.orderBy=a,this.$("#col-"+this.orderBy+" .sortable").removeClass("asc desc").addClass(b),this},b.prototype.onInstanceChange=function(a,b){var c,d=this;return c=a.previous("instance"),null!=c&&(this.$("#item-"+c.id).removeClass("active"),c.off(null,null,this)),null!=b&&(this.$("#item-"+b.id).addClass("active"),b.on("sync destroy",function(){return d.model.fetch()},this)),this},b.prototype.setOrder=function(a){var b,c;return b=$(a.target).data("id"),c=this.model.get("order_dir"),c=b===this.model.get("order_by")?"asc"===c?"desc":"asc":this.entity.columns.get(b).get("order_dir"),this.model.set({order_by:b,order_dir:c}),this},b.prototype.navigate=function(a){return j.router.navigate(this.entity.link($(a.currentTarget).data("id")),{trigger:!0}),this},b.prototype.updateData=function(a,b){return this.$(".items").replaceWith(this.renderBody(this.columns,b)),this},b.prototype.render=function(){var a;return a=this.model.get("data"),this.$el.html(this.renderHead(this.columns)+this.renderBody(this.columns,a)),this.onOrderChange(this.model),this},b.prototype.renderHead=function(a){var b,c,d,e;for(c="<thead><tr>",d=0,e=a.length;e>d;d++)b=a[d],c+=this.renderHeadCell(b);return c+="</tr></thead>"},b.prototype.renderHeadCell=function(a){return'<th class="'+a.getClass()+'" id="col-'+a.id+'">'+a.renderHeadCell()+"</th>"},b.prototype.renderBody=function(a,b){var c,d,e,f;if(c='<tbody class="items">',null!=b&&b.length)for(e=0,f=b.length;f>e;e++)d=b[e],c+=this.renderRow(a,d);else c+='<tr><td class="no-items" colspan="'+a.length+'">Ничего не найдено</td></tr>';return c+="</tbody>"},b.prototype.renderRow=function(a,b){var c,d,e,f,g,h;for(f=this.entity.get("instance"),c=null!=f&&b.id===f.id?"active":"",e='<tr class="item '+c+'" id="item-'+b.id+'" data-id="'+b.id+'">',g=0,h=a.length;h>g;g++)d=a[g],e+=this.renderCell(d,b);return e+="</tr>"},b.prototype.renderCell=function(a,b){return'<td class="'+a.getClass()+'">'+a.renderCell(b[a.id])+"</td>"},b}(Backbone.View),u=function(a){function b(){return ib=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="field-list",b.prototype.initialize=function(){return this.listenTo(this.model.entity.fields,"add remove",this.render),this},b.prototype.focus=function(){var a;return null!=(a=this.primary)&&a.focus(),this},b.prototype.render=function(){var a,b,c,d;for(this.$el.empty(),d=this.createFields(),b=0,c=d.length;c>b;b++)a=d[b],this.$el.append(a.el);return this},b.prototype.createFields=function(){var a,b,c,d,e;for(this.dispose(),this.fields=function(){var b,c,d,e;for(d=this.model.entity.fields.models,e=[],b=0,c=d.length;c>b;b++)a=d[b],e.push(a.createView(this.model).render());return e}.call(this),this.primary=null,e=this.fields,c=0,d=e.length;d>c;c++)if(b=e[c],b.field.isEditable(this.model)){this.primary=b;break}return this.fields},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.fields)for(d=this.fields,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this},b.prototype.stopListening=function(){return this.dispose(),b.__super__.stopListening.apply(this,arguments)},b}(Backbone.View),x=function(a){function b(){return jb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="filter-list",b.prototype.tagName="fieldset",b.prototype.initialize=function(a){return this.entity=a.entity,this},b.prototype.render=function(){var a,b,c,d,e;for(this.dispose(),this.$el.html(this.template()),this.items=this.$(".filter-list-container"),this.filters=[],e=this.entity.columns.models,c=0,d=e.length;d>c;c++)a=e[c],!a.get("searchable")&&a.get("filterable")&&(b=a.createFilterInput(this.model))&&(this.filters.push(b),this.items.append(b.render().el),b.$el.wrap('<div class="form-group filter '+a.getClass()+'"><div class="input-wrap"></div></div>').parent().before("<label>"+a.get("title")+"</label>"));return this},b.prototype.template=function(){return'<div class="filter-list-container"></div>'},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.filters)for(d=this.filters,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(Backbone.View),f=function(a){function b(a){this.key=a.key,b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.initialize=function(){return this.listenTo(this.model,"change:"+this.key,this.applyChanges),this},b.prototype.applyChanges=function(){return this},b.prototype.render=function(){return this.applyChanges(this.model,this.model.get(this.key))},b.prototype.focus=function(){return this},b}(Backbone.View),C=function(a){function b(){return kb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="p",b.prototype.className="form-control-static",b.prototype.initialize=function(a){return null!=a.formatter&&(this.formatter=a.formatter),b.__super__.initialize.apply(this,arguments)},b.prototype.applyChanges=function(){return this.render()},b.prototype.render=function(){var a;return a=this.model.get(this.key),null!=this.formatter&&(a=this.formatter.format(a)),this.$el.html(a),this},b}(f),E=function(a){function b(a){var c,d,e;this.size=null!=(d=a.size)?d:"sm",this.className=null!=(e=a.className)?e:"form-control",this.continous=null!=(c=a.continous)?c:!1,this.className+=" input-"+this.size,b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="input",b.prototype.events={change:"change",keydown:"keydown"},b.prototype.scheduleChange=function(){var a=this;return null!=this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(function(){return a.change()},300),this},b.prototype.keydown=function(a){return a.ctrlKey&&13===a.keyCode?(this.change(),void 0):27===a.keyCode?(this.model.set(this.key,""),!1):(this.continous&&this.scheduleChange(),this)},b.prototype.change=function(){return this.model.set(this.key,this.el.value),this},b.prototype.applyChanges=function(a,b){return this.$el.val(b),this},b.prototype.focus=function(){return this.el.focus(),this},b}(f),F=function(a){function b(){return lb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="textarea",b}(E),h=function(a){function b(){return mb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tagName="label",b.prototype.label="",b.prototype.events={change:"change"},b.prototype.initialize=function(a){return null!=a.label&&(this.label=a.label),b.__super__.initialize.apply(this,arguments)},b.prototype.change=function(){return this.model.set(this.key,this.input.prop("checked")),this},b.prototype.applyChanges=function(a,b){return this.input.prop("checked",b),this},b.prototype.render=function(){return this.input=$("<input>",{type:"checkbox",checked:this.model.get(this.key)}),this.$el.append(this.input),null!=this.label&&this.$el.append(this.label),this},b}(f),g=function(a){function b(){return K=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.tripleState=!1,b.prototype.events={"click input":"check"},b.prototype.initialize=function(a){return null!=a.tripleState?this.tripleState=a.tripleState:void 0},b.prototype.check=function(a){return this.model.set(this.key,function(){switch(a.target.value){case"1":return!0;case"0":return!1;default:return null}}()),this},b.prototype.applyChanges=function(a,b){return b=function(){switch(b){case!0:return"1";case!1:return"0";default:return""}}(),this.$('[value="'+b+'"]').prop("checked",!0),this},b.prototype.render=function(){return this.$el.empty(),this.tripleState&&this.$el.append(this.itemTemplate("неважно","")),this.$el.append(this.itemTemplate("да",1)),this.$el.append(this.itemTemplate("нет",0)),b.__super__.render.apply(this,arguments)},b.prototype.itemTemplate=function(a,b){return'<label class="radio-inline">\n    <input type="radio" name="'+this.cid+'" value="'+b+'">\n    '+a+"\n</label>"},b}(f),n=function(a){function b(){return L=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="entity-dropdown",b.prototype.events={"click .btn-remove":"removeItem","show.bs.dropdown":"renderDropdown"},b.prototype.mutiple=!1,b.prototype.reference=null,b.prototype.initialize=function(a){return null!=a.multiple&&(this.multiple=a.multiple),null!=a.reference&&(this.reference=a.reference),this.active=!1,b.__super__.initialize.apply(this,arguments)},b.prototype.removeItem=function(a){var b,c;return this.multiple?(b=$(a.currentTarget).data("key"),c=_.clone(this.model.get(this.key)),c.splice(b,1)):c=null,this.model.set(this.key,c),this},b.prototype.renderDropdown=function(){return null==this.selector?(this.selector=new r({model:this.model,key:this.key,multiple:this.multiple,reference:this.reference}),this.dropdown=$("<div></div>",{"class":"selector-wrap"}),this.$el.append(this.dropdown.append(this.selector.render().el)),this):void 0},b.prototype.applyChanges=function(){return this.multiple?this.renderItems():(this.updateItem(),this.$el.removeClass("open")),this},b.prototype.render=function(){return this.dispose(),this.multiple?this.renderMultiple():this.renderSingle(),this.$el.attr("id",this.cid),this},b.prototype.renderMultiple=function(){return this.$el.append(this.items=$("<div>",{"class":"items"})),this.$el.append('<button type="button" class="btn btn-default btn-sm btn-block dropdown-toggle" data-toggle="dropdown" data-target="#'+this.cid+'">\n    Выбрать\n    <span class="caret"></span>\n</button>'),this.renderItems()},b.prototype.renderItems=function(){var a,b,c,d,e,f;for(a="",f=this.model.get(this.key),b=d=0,e=f.length;e>d;b=++d)c=f[b],a+=this.itemTemplate(c.title,b);return this.items.html(a),this.items.toggleClass("has-items",""!==a),this},b.prototype.renderSingle=function(){return this.$el.html(this.itemTemplate("","")),this.itemTitle=this.$(".form-control"),this.itemDelete=this.$(".btn-remove"),this.updateItem()},b.prototype.updateItem=function(){var a;return a=this.model.get(this.key),this.itemTitle.text(a?a.title:"Не выбрано"),this.itemDelete.toggle(!!a),this},b.prototype.itemTemplate=function(a,b){var c;return null==b&&(b=null),c='<div class="input-group input-group-sm item">\n    <p class="form-control">'+_.escape(a)+'</p>\n    <div class="input-group-btn">',this.multiple&&null===b||(c+='<button type="button" class="btn btn-default btn-remove" data-key="'+b+'">\n    <span class="glyphicon glyphicon-remove"></span>\n</button>'),this.multiple&&null!==b||(c+='<button type="button" class="btn btn-default btn-dropdown dropdown-toggle" data-toggle="dropdown" data-target="#'+this.cid+'">\n    <span class="caret"></span>\n</button>'),c+="</div></div>"},b.prototype.dispose=function(){return this.selector&&this.selector.stopListening(),this.selector=null,this},b.prototype.stopListening=function(){return this.dispose(),b.__super__.stopListening.apply(this,arguments)},b}(f),r=function(a){function b(){return M=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="entity-selector",b.prototype.events={"click li":"check"},b.prototype.initialize=function(a){var c,d,e=this;return b.__super__.initialize.apply(this,arguments),this.filter=null!=(c=a.filter)?c:!1,this.multiple=null!=(d=a.multiple)?d:!1,this.data=[],this.buildSelected(this.model.get(this.key)),j.app.entity(a.reference).then(function(a){return e.entity=a,e.primaryKey="id",e.primaryColumn=a.get("primary_column"),e.dataSource=a.search(),e.listenTo(e.dataSource,"request",e.loading),e.listenTo(e.dataSource,"data",e.appendItems)}),this},b.prototype.check=function(a){var b,c,d,e;return b=parseInt($(a.target).data("id")),d=b in this.selected,c=_.find(this.data,function(a){return a.id===b}),this.multiple?d?e=_.filter(this.model.get(this.key),function(a){return a.id!==b}):(e=_.clone(this.model.get(this.key)),e.push(c)):e=c,this.model.set(this.key,e),!1},b.prototype.applyChanges=function(a,b){return this.buildSelected(b),this.renderItems()},b.prototype.buildSelected=function(a){var b,c,d;if(this.selected={},this.multiple)for(c=0,d=a.length;d>c;c++)b=a[c],this.selected[b.id]=!0;else null!=a&&(this.selected[a.id]=!0);return this},b.prototype.loading=function(){return this},b.prototype.appendItems=function(a,b){var c,d,e;if(!_.isEmpty(b)){for(d=0,e=b.length;e>d;d++)c=b[d],this.data.push({id:c[this.primaryKey],title:c[this.primaryColumn]});return this.renderItems(),this}},b.prototype.renderItems=function(){var a,b,c,d,e;for(a="",e=this.data,c=0,d=e.length;d>c;c++)b=e[c],a+=this.renderItem(b);return this.items.html(a),this},b.prototype.renderItem=function(a){var b;return b=a.id in this.selected?"selected":"",'<li class="'+b+'" data-id="'+a.id+'">'+a.title+"</li>"},b.prototype.render=function(){return this.dispose(),this.$el.html(this.template()),this.items=this.$(".items"),null!=this.dataSource&&this.dataSource.hasData()&&this.appendItems(this.dataSource,this.dataSource.get("data")),this},b.prototype.template=function(){return'<div class="items-container"><ul class="items"></ul></div>'},b.prototype.dispose=function(){return this},b.prototype.stopListening=function(){return this.dispose(),b.__super__.stopListening.apply(this,arguments)},b}(f),w=function(a){function b(){return N=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="file-list",b.prototype.events={"change [type=file]":"appendFiles","click .action-delete":"deleteFile"},b.prototype.initialize=function(a){var c,d;return this.multiple=null!=(c=a.multiple)?c:!1,this.formatter=null!=(d=a.formatter)?d:{format:function(a){return a instanceof File?a.name:a}},b.__super__.initialize.apply(this,arguments)},b.prototype.deleteFile=function(a){var b;return this.multiple?(b=_.clone(this.model.get(this.key)),b.splice($(a.currentTarget).data("index"),1)):b="",this.model.set(this.key,b),this},b.prototype.appendFiles=function(a){var b,c,d,e,f;if(!_.isEmpty(a.target.files)){if(this.multiple)for(c=_.clone(this.model.get(this.key)),f=a.target.files,d=0,e=f.length;e>d;d++)b=f[d],c.push(b);else c=a.target.files[0];return this.model.set(this.key,c),this}},b.prototype.applyChanges=function(){return this.render()},b.prototype.render=function(){var a,b,c,d,e,f;if(d=this.model.get(this.key),a="",this.multiple)for(b=e=0,f=d.length;f>e;b=++e)c=d[b],a+=this.renderItem(c,b);else d&&(a+=this.renderItem(d));return a&&(a=this.wrapItems(a)),a+=this.renderInput(this.multiple?"Добавить":"Выбрать"),this.$el.html(a),this},b.prototype.wrapItems=function(a){return'<ul class="list-group">'+a+"</ul>"},b.prototype.renderInput=function(a){return'<div class="btn btn-sm btn-default file-list-input-wrap">\n    <input type="file" '+(this.multiple?"multiple":void 0)+">\n    "+a+"\n</div>"},b.prototype.renderItem=function(a,b){var c;return null==b&&(b=0),c=this.formatter.format(a),'<li class="list-group-item">\n    <a href="#" class="action-delete pull-right" data-index="'+b+'"><span class="glyphicon glyphicon-remove"></span></a>\n\n    '+c+"\n</li>"},b}(f),y=function(a){function b(){this.className+=" image-list",this.readers=[],b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.initialize=function(a){var c,d;return this.width=null!=(c=a.width)?c:40,this.height=null!=(d=a.height)?d:40,b.__super__.initialize.apply(this,arguments)},b.prototype.render=function(){var a,c,d,e;for(b.__super__.render.apply(this,arguments),e=this.readers,c=0,d=e.length;d>c;c++)a=e[c],a.readAsDataURL(a.item);return this.readers=[],this.$(".fancybox").fancybox(),this},b.prototype.renderItem=function(a,b){var c;return null==b&&(b=0),c=this.formatter.format(a),'<li class="list-group-item">\n    '+this.renderImage(a,b)+'\n    <a href="#" class="action-delete pull-right" data-index="'+b+'"><span class="glyphicon glyphicon-remove"></span></a>\n\n    '+c+"\n</li>"},b.prototype.renderImage=function(a,b){var c,d;return null==b&&(b=0),c=this.key+b,a instanceof File?(d=a.data?"background-image:url("+a.data:"",null==a.data&&this.readers.push(this.createPreviewLoader(a,c))):d="background-image:url('"+a+"')",'<a href="'+(a instanceof File?a.data||"#":a)+'" class="fancybox">\n    <span class="image-thumbnail" id="'+c+'" style="width:'+this.width+"px;height:"+this.height+"px;"+d+'"></span>\n</a>'},b.prototype.createPreviewLoader=function(a,b){var c;return c=new FileReader,c.item=a,c.onload=function(a){return a.target.item.data=a.target.result,$("#"+b).css("background-image","url("+a.target.result+")").parent().attr("href",a.target.result)},c},b}(w),j.fields=new s,v=function(a){function b(a){var c,d;this.inputId=a.model.entity.id+"_"+a.field.id,c=" "+this.className+"-",d=[a.field.attributes.type,a.field.id,this.inputId],this.className+=c+d.join(c),a.field.get("required")&&(this.className+=" required"),b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="field",b.prototype.initialize=function(a){return this.field=a.field,this.listenTo(this.field,"change:visible",this.toggleVisibility),this.listenTo(this.field,"change:editable",this.render),this.listenTo(this.model,"sync",this.render),this.listenTo(this.model,"request",this.hideError),this.listenTo(this.model,"invalid",this.showError),this},b.prototype.hideError=function(){return this.error.hide(),this.inputHolder.removeClass("has-error")},b.prototype.showError=function(a,b){var c;return c=b[this.field.get("id")],c?(this.inputHolder.addClass("has-error"),this.error.text(c).show()):void 0},b.prototype.render=function(){return null!=this.input&&this.input.remove(),this.$el.html(this.template()),this.inputHolder=this.$(".input-holder"),this.input=this.field.createInput(this.model),null!=this.input&&this.inputHolder.append(this.input.render().el),this.inputHolder.append(this.error=$(this.errorTemplate())),this.toggleVisibility(),this},b.prototype.helpTemplate=function(){var a;return a=this.field.get("help"),a?'<span class="glyphicon glyphicon-question-sign field-help" title="'+a+'"></span>':""},b.prototype.errorTemplate=function(){return'<span class="help-block error"></span>'},b.prototype.label=function(a){return null==a&&(a=this.field.get("label")),'<label for="'+this.inputId+'">'+a+"</label>"},b.prototype.template=function(){return""+this.helpTemplate()+'\n<div class="form-group input-holder">\n    '+this.label()+"\n</div>"},b.prototype.isVisible=function(){return this.field.get("visible")&&(this.field.get("editable")&&this.field.get("updatable")||!this.model.isNew())},b.prototype.toggleVisibility=function(){return this.$el.toggle(this.isVisible())},b.prototype.focus=function(){return null!=this.input&&this.input.focus(),this},b.prototype.stopListening=function(){return null!=this.input&&this.input.stopListening(),b.__super__.stopListening.apply(this,arguments)},b}(Backbone.View),t=function(a){function b(){return O=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.viewConstructor=v,b.prototype.createView=function(a){return new this.viewConstructor({model:a,field:this})},b.prototype.createInput=function(a){var b;return this.isEditable(a)&&(b=this.createEditableInput(a)),null!=b?b:new C({model:a,key:this.id,formatter:this})},b.prototype.createEditableInput=function(){return null},b.prototype.format=function(a){return a?a:"n/a"},b.prototype.isEditable=function(a){return this.get("editable")&&(this.get("updatable")||!a.isNew())&&a.isSaveable()},b}(e),j.fields.Input=function(a){function b(){return P=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createEditableInput=function(a){var b,c;return b={placeholder:this.get("label")},c=this.get("input_type"),"textarea"===c?(b.rows=this.get("rows"),new F({model:a,key:this.id,attributes:b})):(b.type=c,new E({model:a,key:this.id,attributes:b}))},b.prototype.format=function(){return"textarea"===this.get("input_type")?"<pre>"+b.__super__.format.apply(this,arguments)+"</pre>":b.__super__.format.apply(this,arguments)},b.prototype.createFilterInput=function(a){return new E({model:a,key:this.id,attributes:{placeholder:this.get("label")}})},b}(t),j.fields.DateTime=function(a){function b(){return Q=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.format=function(a){return null===a?"никогда":moment.unix(a).calendar()},b}(j.fields.Input),j.fields.Boolean=function(a){function b(){return R=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createEditableInput=function(a){return new g({model:a,key:this.id})},b.prototype.createFilterInput=function(a){return new g({model:a,key:this.id,tripleState:!0})},b.prototype.format=function(a){return a?"да":"нет"},b}(t),j.fields.Relation=function(a){function b(){return S=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createEditableInput=function(a){return new n({model:a,key:this.id,multiple:this.get("multiple"),reference:this.get("reference")})},b.prototype.createFilterInput=function(a){return this.createEditableInput(a)},b.prototype.format=function(a){return _.isEmpty(a)?"не указано":this.attributes.multiple?_.pluck(a,"title").join(", "):a.title},b}(t),j.fields.File=function(a){function b(){return T=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createEditableInput=function(a){return new w({model:a,key:this.id,multiple:this.get("multiple"),attributes:{accepts:this.get("accepts")}})},b.prototype.format=function(a){return a instanceof b?a.name:a},b}(t),j.fields.Image=function(a){function b(){return V=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createEditableInput=function(a){return new y({model:a,key:this.id,width:this.get("width"),height:this.get("height"),multiple:this.get("multiple"),attributes:{accepts:this.get("accepts")}})},b.prototype.format=function(a){return a instanceof File?a.name:a},b}(j.fields.File),j.columns=new s,i=function(a){function b(){return W=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.renderHeadCell=function(){var a,b;return b=this.get("title"),a=this.get("help"),this.get("sortable")&&(b='<span class="sortable" data-id="'+this.id+'">'+b+"</span>"),a?'<span class="glyphicon glyphicon-question-sign" title="'+a+'"></span> '+b:b},b.prototype.renderCell=function(a){return a},b.prototype.createFilterInput=function(){return null},b.prototype.getClass=function(){return"col-"+this.id},b}(e),j.columns.Field=function(a){function b(){return X=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.initialize=function(a){var c,d;return c=null!=(d=a.field)?d:a.id,this.field=a.entity.fields.get(c),null===a.title&&this.set("title",this.field.get("label")),b.__super__.initialize.apply(this,arguments)},b.prototype.renderCell=function(a){return this.field.format(a)},b.prototype.createFilterInput=function(a){return this.field.createFilterInput(a,this)},b.prototype.getClass=function(){return b.__super__.getClass.apply(this,arguments)+" col-"+this.field.get("type")},b}(i),j.columns.Computed=function(a){function b(){return Y=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.createFilterInput=function(a){return new E({model:a,key:this.id,attributes:{placeholder:this.get("title")}})},b.prototype.getClass=function(){return b.__super__.getClass.apply(this,arguments)+" col-computed"},b}(i),j.related=new s,A=function(a){function b(){return Z=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.resolve=function(){var a=this;return j.app.entity(this.get("related")).then(function(b){return a.related=b})},b}(Backbone.Model),j.related.One=function(a){function b(){return ab=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.associate=function(a,b){return b.set(this.get("foreign_key"),a.id),this},b}(A),j.related.MorphOne=function(a){function b(){return bb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.associate=function(a,c){return c.set(this.get("morph_type"),this.get("morph_class")),b.__super__.associate.apply(this,arguments)},b}(j.related.One),m=function(a){function b(){return cb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.initialize=function(a){return this.fields=this.createCollection(j.fields,a.fields),this.columns=this.createCollection(j.columns,a.columns),this.related=this.createCollection(j.related,a.related),null===this.get("label")?this.set("label",H(this.id)):void 0},b.prototype.createCollection=function(a,b){var c,d,e,f,g;for(c=[],f=0,g=b.length;g>f;f++)e=b[f],e.entity=this,d=a.create(e["class"],e),null!=d&&c.push(d);return new Backbone.Collection(c)},b.prototype.createDataSource=function(a){var b;return null==a&&(a=null),b={order_by:this.get("order_by")||this.get("primary_column")},b.order_dir=null!=b.order_dir?this.columns.get(b.order_by).get("order_dir"):"asc",new l(b,{entity:this,columns:a,filter:new Backbone.Model})},b.prototype.createFilters=function(a){var b,c;return null==a&&(a=this.columns),c=function(){var c,d,e,f;for(e=a.models,f=[],c=0,d=e.length;d>c;c++)b=e[c],b.get("filterable")&&f.push(b.createFilter());return f}(),new Backbone.Collection(c)},b.prototype.createInstance=function(a,b){var c,d,e,f,g;for(null==a&&(a={}),null==b&&(b={}),d={},g=this.related.models,e=0,f=g.length;f>e;e++)c=g[e],d[c.id]=c.related.createInstance(b[c.id]);return console.log(this.related),new p(_.extend({},this.get("defaults"),a),{entity:this,related:d})},b.prototype.search=function(){return null==this.searchInstance&&(this.searchInstance=this.createDataSource(["id",this.get("primary_column")])),this.searchInstance.set("current_page",1),this.searchInstance},b.prototype.load=function(a){var b=this;return $.getJSON(this.url(a)).then(function(a){return a=a.data,b.createInstance(a.model,a.related)})},b.prototype.update=function(a){var b=this;return this.load(a).then(function(a){return console.log(a),b.set("instance",a),a})},b.prototype.url=function(a){return G(this.id,a)},b.prototype.link=function(a){return""+this.id+(null!=a?"/"+a:"")},b}(Backbone.Model),p=function(a){function c(){return db=c.__super__.constructor.apply(this,arguments)}return ob(c,a),c.prototype.initialize=function(a,b){var c=this;return this.entity=b.entity,this.related=b.related,this.original=_.clone(a),this.on("error",this.processError,this),this.on("sync",function(){return c.original=_.clone(c.attributes)}),this.on("destroy",function(){return c.entity.get("soft_deleting")?c.set("deleted_at",moment().unix()):void 0
})},c.prototype.processError=function(a,b){return null!=b.responseJSON&&"VALIDATION"===b.responseJSON.error?this.trigger("invalid",this,b.responseJSON.data):void 0},c.prototype.validate=function(){return this.set("errors",{}),null},c.prototype.link=function(){return this.entity.link(this.id)},c.prototype.url=function(){return this.entity.url(this.id)},c.prototype.sync=function(a,d,e){var f;return("update"===a||"create"===a)&&(e.data=new b(null!=(f=e.attrs)?f:this.attributes).original,e.contentType=!1,e.processData=!1),c.__super__.sync.apply(this,arguments)},c.prototype.save=function(){var a,b,d=this;return b=c.__super__.save.apply(this,arguments),_.isEmpty(this.related)?b:(a=function(a){var b,c,e,f;e=[],null!=a&&e.push(a),f=d.related;for(b in f)c=f[b],c.isNew()&&d.entity.related.get(b).associate(d,c),c.hasChangedSinceSync()&&e.push(c.save());return $.when.apply(e)},this.isNew()?b.then(function(){return a()}):a(b))},c.prototype.parse=function(a){return a.data},c.prototype.hasChangedSinceSync=function(){var a,b,c,d,e;d=this.attributes;for(a in d)if(c=d[a],!_.isEqual(c,this.original[a]))return!0;if(!this.isNew()){e=this.related;for(a in e)if(b=e[a],b.hasChangedSinceSync())return!0}return!1},c.prototype.isSaveable=function(){return this.isNew()&&this.entity.get("can_create")||!this.isNew()&&this.entity.get("can_update")},c}(Backbone.Model),q=function(a){function b(a){this.className+=" "+this.className+"-"+a.model.id,b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="entity-page",b.prototype.events={"click .btn-create":"create"},b.prototype.initialize=function(){return this.listenTo(this.model,"change:instance",this.toggleForm),b.__super__.initialize.apply(this,arguments)},b.prototype.toggleForm=function(a,b){return null!=this.form&&(this.stopListening(this.form.model),this.form.remove()),null!=b&&(this.listenTo(b,"sync",function(){return j.router.navigate(b.link())}),this.form=new o({model:b}),this.$el.append(this.form.render().$el),this.form.show()),this},b.prototype.create=function(){return j.router.navigate(this.model.link("create"),{trigger:!0}),this},b.prototype.render=function(){return this.dispose(),this.$el.html(this.template()),this.dataSource=this.model.createDataSource(),this.dataGrid=new k({model:this.dataSource}),this.pagination=new z({model:this.dataSource}),this.filterList=new x({model:this.dataSource.filter,entity:this.dataSource.entity}),this.search=new E({model:this.dataSource,key:"search",continous:!0,attributes:{type:"search",placeholder:"поиск"}}),this.dataSource.fetch(),this.$(".col-search").append(this.search.render().el),this.$(".col-filters").append(this.filterList.render().el),this.$el.append(this.dataGrid.render().el),this.$el.append(this.pagination.render().el),this},b.prototype.template=function(){var a;return a='<h1 class="page-header">\n    '+this.model.get("title")+"\n",this.model.get("can_create")&&(a+='<button class="btn btn-default btn-create" type="button">\n    <span class="glyphicon glyphicon-plus"</span>\n</button>'),a+="</h1>",a+='<div class="row row-search"><div class="col-xs-2 col-search"></div><div class="col-xs-10 col-filters"></div></div>'},b.prototype.dispose=function(){return null!=this.form&&this.form.remove(),null!=this.filterList&&this.filterList.remove(),null!=this.dataGrid&&this.dataGrid.remove(),null!=this.pagination&&this.pagination.remove(),null!=this.search&&this.search.remove(),null!=this.dataSource&&this.dataSource.stopListening(),this},b.prototype.remove=function(){return this.dispose(),b.__super__.remove.apply(this,arguments)},b}(Backbone.View),o=function(a){function b(a){this.className+=" "+this.className+"-"+a.model.entity.id,b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.className="entity-form",b.prototype.events={"click .btn-save":"save","click .btn-close":"close","click .btn-destroy":"destroy"},b.prototype.initialize=function(){var a,b,c;this.listenTo(this.model,"destroy",this.handleDestroy),this.signOn(this.model),c=this.model.related;for(a in c)b=c[a],this.signOn(b);return this.hotkeys=$(document).on("keydown."+this.cid,"body",$.proxy(this,"hotkeys")),this},b.prototype.signOn=function(a){return this.listenTo(a,"change",this.enableSubmit),this.listenTo(a,"invalid",this.displayInvalid)},b.prototype.hotkeys=function(a){return a.ctrlKey&&90===a.keyCode?(this.model.set(this.model.previousAttributes()),!1):a.ctrlKey&&13===a.keyCode?(this.save(),!1):27===a.keyCode?(this.close(),!1):this},b.prototype.enableSubmit=function(){return this.submit.attr("disabled",this.model.hasChangedSinceSync()===!1),this},b.prototype.displayAlert=function(a,b){return null!=this.alert&&this.alert.remove(),this.alert=new c({message:a,className:"flash",type:b,timeout:3e3}),this.footer.prepend(this.alert.render().el),this},b.prototype.displaySuccess=function(){return this.displayAlert("Получилось!","success")},b.prototype.displayInvalid=function(){return this.displayAlert("Не получилось...","warning")},b.prototype.displayError=function(a){return null==a.responseJSON||"VALIDATION"!==a.responseJSON.error?this.displayAlert("Ошибка","danger"):void 0},b.prototype.handleDestroy=function(){return this.model.entity.get("soft_deleting")?this.update():j.router.navigate(this.model.entity.link(),{trigger:!0}),this},b.prototype.show=function(){var a=this;return setTimeout(function(){return a.$el.toggleClass("opened",!0),a.tabs[0].focus()},50),this},b.prototype.save=function(){var a=this;if(null==this.request&&this.model.hasChangedSinceSync())return this.request=this.model.save().then($.proxy(this,"displaySuccess"),$.proxy(this,"displayError")),this.request.always(function(){return a.request=null,a.update()}),this.update(),this},b.prototype.close=function(){var a;return a=this.request?confirm("Вы точно хотите закрыть форму и отменить операцию?"):this.model.hasChangedSinceSync()?confirm("Вы точно хотите закрыть форму? Все изменения будут утеряны!"):!0,a&&(this.request&&this.request.abort(),j.router.navigate(this.model.entity.link(),{trigger:!0})),this},b.prototype.destroy=function(){var a,b;if(!this.request&&!this.model.isNew())return b=this.model.entity.get("soft_deleting"),a=b?!0:confirm("Точно удалить? Восстановить не получится!"),this.request=this.softDeleting&&this.model.get("deleted_at")?this.model.restore:a?this.model.destroy({wait:!0}):void 0,this},b.prototype.render=function(){var a,b,c;this.dispose(),this.$el.html(this.template()),this.nav=this.$(".nav"),this.footer=this.$("footer"),this.submit=this.$(".btn-save"),this.destroy=this.$(".btn-destroy"),this.tabs=[],this.renderTab(this.model,!0),c=this.model.related;for(a in c)b=c[a],this.renderTab(b);return this.update()},b.prototype.renderTab=function(a,b){var c,d;return this.tabs.push(c=new u({model:a})),d="tab-"+a.entity.id,c.render().$el.insertBefore(this.footer).wrap($("<div></div>",{id:d,"class":"wrap"+(b?" active":"")})),this.nav.append(this.navTemplate(a.entity.get("singular"),d,b)),this},b.prototype.update=function(){return this.$el.toggleClass("loading",null!=this.request),this.submit.text(this.model.isNew()?"Создать":"Сохранить"),this.submit.attr("disabled",this.model.hasChangedSinceSync()===!1||this.request===!0),this.submit.toggle(this.model.entity.get(this.model.isNew()?"can_create":"can_update")),this.destroy.attr("disabled",this.request===!0),this.destroy.text(this.model.entity.get("soft_deleting"&&this.model.get("deleted_at"))?"Восстановить":"Удалить"),this.destroy.toggle(!this.model.isNew()&&this.model.entity.get("can_delete")),this},b.prototype.template=function(){return'<header>\n    <ul class="nav nav-pills"></ul>\n</header>\n\n<footer>\n    <button class="btn btn-default btn-close btn-sm" type="button">Закрыть</button>\n    <button class="btn btn-default btn-destroy btn-sm" type="button">Удалить</button>\n    <button class="btn btn-primary btn-save btn-sm" type="button" disabled></button>\n</footer>'},b.prototype.navTemplate=function(a,b,c){return c=c?' class="active"':"","<li"+c+'><a href="#'+b+'" data-toggle="tab">'+a+"</a></li>"},b.prototype.remove=function(){var a=this;return this.$el.one(D,function(){return a.dispose(),$(document).off("."+a.cid),b.__super__.remove.apply(a,arguments)}).removeClass("opened"),this},b.prototype.dispose=function(){var a,b,c,d;if(null!=this.tabs)for(d=this.tabs,b=0,c=d.length;c>b;b++)a=d[b],a.remove();return this},b}(Backbone.View),$(".navbar").on("click",".entity",function(a){var b,c;return a.preventDefault(),b=j.root+"/"+j.uri+"/",c=a.currentTarget.href.substr(b.length),j.router.navigate(c,{trigger:!0})}),d=function(a){function b(){return eb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.entities={},b.prototype.initialize=function(){return this.container=$("#container"),this.on("change:entity",this.displayEntity,this)},b.prototype.displayEntity=function(a,b){return null!=this.page&&this.page.remove(),null!=b?this.container.append((this.page=new q({model:b})).render().el):void 0},b.prototype.entity=function(a){var b,c=this;return b=a in this.entities?$.Deferred().resolve(this.entities[a]).promise():$.getJSON(G(a,"schema")).then(function(b){var d,e,f;return c.entities[a]=d=new m(b.data),_.isEmpty(d.related.models)?d:(f=function(){var a,b,c,f;for(c=d.related.models,f=[],a=0,b=c.length;b>a;a++)e=c[a],f.push(e.resolve());return f}(),$.when.apply($,f).then(function(){return d}))})},b}(Backbone.Model),j.app=new d,B=function(a){function b(){return gb=b.__super__.constructor.apply(this,arguments)}return ob(b,a),b.prototype.routes={":page":"page",":page/create":"create",":page/:id":"update"},b.prototype.page=function(a){return j.app.entity(a).then(function(a){return a.set("instance",null),j.app.set("entity",a),a})},b.prototype.create=function(a){return this.page(a).then(function(a){return a.set("instance",a.createInstance())})},b.prototype.update=function(a,b){return this.page(a).then(function(a){return a.update(b)})},b}(Backbone.Router),j.router=new B,Backbone.history.start({root:j.uri+"/",pushState:!0,hashChange:!1})}).call(this);
//# sourceMappingURL=app.min.js.map